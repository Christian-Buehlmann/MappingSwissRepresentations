---
title: "Drawing beautiful maps programmatically with R, sf and ggplot2 - Part 2: Layers"
author: "BCN, based on Mel Moreno and Mathieu Basille https://r-spatial.org/r/2018/10/25/ggplot2-sf-2.html"
output:
  html_document:
    fig_caption: no
    toc: yes
    toc_depth: 2
    toc_float:
      collapsed: no
  pdf_document:
    toc: yes
    toc_depth: '2'
---

```{r global_options, include = FALSE}
knitr::opts_chunk$set(
    message = FALSE,
    warning = FALSE,
    cache = TRUE,
    tidy = FALSE,
    fig.width = 7,
    fig.height = 7,
    out.width = "65%")

## This is just to "pre-load" all packages, and prevent the startup
## messages to show

library("ggplot2")
library("sf")
library("rnaturalearth")
library("rnaturalearthdata")
library("ggspatial")
library("maps")
library("tools")
library("googleway")
library("ggrepel")

library("rnaturalearth")
library("rnaturalearthdata")

library("readxl")
library("dplyr")

```

```{r further_options, include = FALSE}

install.packages(c("cowplot", "googleway", "ggplot2", "ggrepel",  "dplyr", 
    "ggspatial", "lwgeom", "rnaturalearth", "sf", "rnaturalearthdata"))

library("ggplot2")
theme_set(theme_bw())
library("sf")
library("rnaturalearth")
library("rnaturalearthdata")
library("rnaturalearthdata")

library(readxl)
library(dplyr)    # To assist with cleaning and organizing data

```

```{r SetupData}

# Get World Map Data ---------------------------------------------------

world <- ne_countries(scale = "medium", returnclass = "sf")

target_crs <- "+proj=gall"

# Read and Join Swiss Missions Data --------------------------------------------

# Read Swiss Missions Data and Filter Them

SwissAsianMissionsData <- read_excel("SwissMissionsInAsiaData-2024-06-06-c.xlsx", na = "NA") %>%
  filter(APacRegion != "FALSE")  %>%
  filter(iso_a3_eh == Pays_Ambassade)

MapCountriesWithSwissEmbassy <- world %>%
  select(geometry, name, "iso_a3_eh") %>%
  left_join(SwissAsianMissionsData, by = "iso_a3_eh") %>%
  filter(APacRegion != "FALSE")

# Read city coordinates

CityDB <- read_excel("worldcities-2024-06-06.xlsx") %>%
  select(city_ascii,'iso_a3_eh', 'lat', 'lng')

# corriger les différences de dénomination

CityDB$city_ascii <- str_replace(CityDB$city_ascii, "Rangoon", "Yangon")

# Create a SwissAsianMissionsLocations by selecting the city  ------------------
# from SwissAsianMissionsData and joining the dataset with the cityDB

# Create a Subset of the SwissAsianMissionsData with the locations

SwissAsianMissionsCities <- SwissAsianMissionsData %>%
  select('city_ascii', 'iso_a3_eh', 'APacRegion') %>%
  filter(city_ascii != "NA")

# Join data sets

SwissAsianMissionsLocations <- CityDB %>%
  select('city_ascii', 'lng', 'lat') %>%
  right_join(SwissAsianMissionsCities, by = 'city_ascii')

```

A better, more flexible alternative is to use the power of `sf`: Converting the data frame to a `sf` object allows to rely on `sf` to handle on the fly the coordinate system (both projection and extent), which can be very useful if the two objects (here world map, and sites) are not in the same projection. 

To achieve the same result, the projection (here WGS84, which is the CRS code #4326) has to be a priori defined in the `sf` object:

```{r SwissAsianMissionsLocations-sf-create}
(SwissAsianMissionsLocationsGeo <- st_as_sf(SwissAsianMissionsLocations, coords = c("lng", "lat"), remove = FALSE,
    crs = 4326, agr = "constant"))
```
```{r layers-final-plot0 fig.width = 15, out.width = "75%"}
library("ggrepel")

cols <- c("none" = "grey", "TRUE" = "darkblue", "FALSE" = "lightblue")
world %>%
  filter(admin != "Antarctica") %>%
  st_transform(crs = target_crs) %>%
  ggplot() +
  geom_sf(color = "white") +
  geom_sf(data = MapCountriesWithSwissEmbassy, aes(fill = APacRegion), color="white") +
  geom_sf(data = SwissAsianMissionsLocationsGeo) +
  geom_text(data = SwissAsianMissionsLocationsGeo, aes(x = lng, y = lat, label = city_ascii), 
        size = 3.9, col = "black", fontface = "bold")
  
  geom_sf(data = SwissAsianMissionsLocationsGeo, color="red") +
  geom_text_repel(data = SwissAsianMissionsLocationsGeo, aes(x = lng, y = lat, label = city_ascii), 
        fontface = "bold", nudge_x = c(1, -1.5, 2, 2, -1), nudge_y = c(0.25, 
            -0.25, 0.5, 0.5, -0.5)) 
```
 +
#  coord_sf(
#    xlim = window_coord_sf[, "X"],
#    ylim = window_coord_sf[, "Y"],
#    expand = FALSE
#  ) +
  theme_minimal() +
  theme(plot.title = element_text(face = "bold"),
        axis.text.x = element_blank()) +
  labs(title = "Asia Pacific",
       subtitle = "Swiss Representations",
       x = NULL, y = NULL,
       caption = "BCN")

```{r layers-final-plot1,  fig.width = 15, out.width = "75%"}
library("ggrepel")

cols <- c("none" = "grey", "TRUE" = "darkblue", "FALSE" = "lightblue")
world %>%
  filter(admin != "Antarctica") %>%
  st_transform(crs = target_crs) %>%
  ggplot() +
  geom_sf(color = "white") +
  geom_sf(data = MapCountriesWithSwissEmbassy, aes(fill = APacRegion), color="white") +
  geom_sf(data = SwissAsianMissionsLocationsGeo, color="red") +
  geom_text_repel(data = SwissAsianMissionsLocationsGeo, aes(x = lng, y = lat, label = city_ascii), 
        fontface = "bold", nudge_x = c(1, -1.5, 2, 2, -1), nudge_y = c(0.25, 
            -0.25, 0.5, 0.5, -0.5)) +
#  coord_sf(
#    xlim = window_coord_sf[, "X"],
#    ylim = window_coord_sf[, "Y"],
#    expand = FALSE
#  ) +
  theme_minimal() +
  theme(plot.title = element_text(face = "bold"),
        axis.text.x = element_blank()) +
  labs(title = "Asia Pacific",
       subtitle = "Swiss Representations",
       x = NULL, y = NULL,
       caption = "BCN") 
```


```{r cities-plot-nudge}
library("ggrepel")
ggplot(data = world) +
    geom_sf() +
    geom_sf(data = counties, fill = NA, color = gray(.5)) +
    geom_sf(data = flcities) +
    geom_text_repel(data = flcities, aes(x = lng, y = lat, label = city), 
        fontface = "bold", nudge_x = c(1, -1.5, 2, 2, -1), nudge_y = c(0.25, 
            -0.25, 0.5, 0.5, -0.5)) +
    coord_sf(xlim = c(-88, -78), ylim = c(24.5, 33), expand = FALSE)
```



```{r layers-final-plot, fig.width = 15, out.width = "75%"}
  
library("ggrepel")
ggplot(data = world) +
    geom_sf() +
    geom_sf(data = SwissAsianMissionsDataGeo, fill = APacRegion != "FALSE", color = gray(.5)) +
    geom_sf(data = flcities) +
    geom_text_repel(data = flcities, aes(x = lng, y = lat, label = city), 
        fontface = "bold", nudge_x = c(1, -1.5, 2, 2, -1), nudge_y = c(0.25, 
            -0.25, 0.5, 0.5, -0.5)) +
    coord_sf(xlim = c(-88, -78), ylim = c(24.5, 33), expand = FALSE)

```
  


  coord_sf(
    xlim = window_coord_sf[, "X"],
    ylim = window_coord_sf[, "Y"],
    expand = FALSE
  )
  
  
    ggrepel::geom_label_repel(
    data = SwissMissionsDataGeo,
    aes(label = name.x, geometry = geometry),
    stat = "sf_coordinates",
    min.segment.length = 10,
    max.overlap = Inf
  )  
+
  scale_fill_manual(values = cols) +
  theme_minimal() +
  theme(plot.title = element_text(face = "bold"),
        axis.text.x = element_blank()) +
  labs(title = "Business Data",
       subtitle = "Interests",
       x = NULL, y = NULL,
       caption = "SICPA")


